---
# Generate Basic auth token dynamically (base64 encoded username:password)
- name: Generate and get Operations Fleet Management Basic auth token
  tags: always
  when: ops_fm_defaults_fetch_token_dynamically | bool
  block:
    - name: Generate base64 encoded credentials
      ansible.builtin.set_fact:
        credentials_string: "{{ lookup('vars', 'var_vault_operations_fm_api_username') }}:{{ lookup('vars', 'var_vault_operations_fm_api_password') }}"

    - name: Encode credentials to base64
      ansible.builtin.set_fact:
        var_vault_operations_fm_api_token: "{{ credentials_string | b64encode }}"

###################################################################################################################################
- name: VCFA-9X-000371
  tags: [VCFA-9X-000371]
  when: ops_fm_defaults_run_vcfa_9x_000371 | bool
  block:
    - name: VCFA-9X-000371 - Get authoritative time server
      ansible.builtin.uri:
        url: "https://{{ lookup('vars', 'ansible_host') }}/lcm/lcops/api/v2/settings/system-details/time"
        validate_certs: "{{ validate_certificate_uri }}"
        headers:
          Authorization: "Basic {{ lookup('vars', 'var_vault_operations_fm_api_token') }}"
          Accept: "application/json"
        method: GET
      register: timesettings
      changed_when: false

    - name: VCFA-9X-000371 - Update time server settings
      ansible.builtin.uri:
        url: "https://{{ lookup('vars', 'ansible_host') }}/lcm/lcops/api/v2/settings/system-details/time"
        validate_certs: "{{ validate_certificate_uri }}"
        headers:
          Authorization: "Basic {{ lookup('vars', 'var_vault_operations_fm_api_token') }}"
          Accept: "application/json"
        method: POST
        body: "{{ lookup('template', './ops_fm_update_time_servers.json.j2') }}"
        body_format: json
        status_code:
          - 200
      register: sessionresponse
      when:
        - not timesettings.json['ntpServerEnabled'] | bool or
          not timesettings.json['ntpServerStarted'] | bool or
          timesettings.json['ntpServers'] != ops_fm_defaults_time_servers
      changed_when:
        - sessionresponse.status == 200
